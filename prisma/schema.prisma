generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       Int                  @id @default(autoincrement())
  name                     String
  email                    String               @unique
  password                 String
  address                  String?
  phone                    String?
  isAdmin                  Boolean              @default(false)
  emailVerified            Boolean              @default(false)
  verificationToken        String?
  verificationTokenExpiry  DateTime?
  resetPasswordToken       String?
  resetPasswordTokenExpiry DateTime?
  createdAt                DateTime             @default(now())
  loyaltyPoints            Int                  @default(0)
  loyaltyTier              String               @default("BRONZE")
  cart                     CartItem[]
  orders                   Order[]
  statusLogs               OrderStatusLog[]
  reviews                  ProductReview[]
  wishlist                 WishlistItem[]
  adminLogs                AdminLog[]
  loyaltyTransactions      LoyaltyTransaction[]
  notifications            Notification[]
  orderHistory             OrderHistory[]
  productHistory           ProductHistory[]

  @@index([email])
  @@index([createdAt])
  @@index([isAdmin])
}

model Order {
  id                   Int                  @id @default(autoincrement())
  userId               Int?
  total                Float
  name                 String
  phone                String
  address              String
  note                 String?
  paymentMethod        String
  status               String
  vnpayTransactionNo   String?
  vnpayBankCode        String?
  vnpayCardType        String?
  vnpayPayDate         String?
  vnpayResponseCode    String?
  vnpayResponseMessage String?
  paidAt               DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  user                 User?                @relation(fields: [userId], references: [id])
  items                OrderItem[]
  statusLogs           OrderStatusLog[]
  loyaltyTransactions  LoyaltyTransaction[]
  history              OrderHistory[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentMethod])
  @@index([status, createdAt])
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  productId Int
  name      String
  price     Float
  quantity  Int
  image     String?
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model WishlistItem {
  id            Int      @id @default(autoincrement())
  userId        Int
  productId     Int
  name          String
  price         Float
  image         String?
  originalPrice Float?
  discount      Int?
  rating        Float?
  reviews       Int?
  createdAt     DateTime @default(now())
  product       Product  @relation(fields: [productId], references: [id])
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([userId, productId])
}

model CartItem {
  id            Int      @id @default(autoincrement())
  userId        Int
  productId     Int
  name          String
  price         Float
  quantity      Int
  image         String?
  originalPrice Float?
  discount      Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  product       Product  @relation(fields: [productId], references: [id])
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([userId, productId])
}

model DiscountCode {
  id           Int       @id @default(autoincrement())
  code         String    @unique
  name         String
  description  String?
  discount     Int
  minAmount    Float?
  maxDiscount  Float?
  freeShipping Boolean   @default(false)
  isActive     Boolean   @default(true)
  validFrom    DateTime?
  validTo      DateTime?
  usageLimit   Int?
  usedCount    Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validTo])
}

model OrderStatusLog {
  id        Int      @id @default(autoincrement())
  orderId   Int
  status    String
  reason    String?
  changedBy Int
  changedAt DateTime @default(now())
  user      User     @relation(fields: [changedBy], references: [id])
  order     Order    @relation(fields: [orderId], references: [id])
}

model Product {
  id            Int              @id @default(autoincrement())
  name          String
  slug          String           @unique
  description   String?
  price         Float
  originalPrice Float?
  discount      Int?
  image         String?
  images        String?
  category      String?
  subcategory   String?
  brand         String?
  weight        Float?
  unit          String?
  stock         Int              @default(0)
  minStock      Int              @default(5)
  isActive      Boolean          @default(true)
  isFeatured    Boolean          @default(false)
  isFlashSale   Boolean          @default(false)
  rating        Float            @default(0)
  reviewCount   Int              @default(0)
  tags          String?
  nutrition     String?
  storage       String?
  expiry        Int?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  cartItems     CartItem[]
  orderItems    OrderItem[]
  reviews       ProductReview[]
  wishlistItems WishlistItem[]
  history       ProductHistory[]

  @@index([slug])
  @@index([category])
  @@index([isActive])
  @@index([isFeatured])
  @@index([isFlashSale])
  @@index([category, isActive])
  @@index([createdAt])
}

model ProductReview {
  id         Int      @id @default(autoincrement())
  productId  Int
  userId     Int
  rating     Int
  title      String?
  comment    String?
  images     String?
  isVerified Boolean  @default(false)
  helpful    Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
  @@index([productId, createdAt])
}

model LoyaltyTransaction {
  id          Int       @id @default(autoincrement())
  userId      Int
  orderId     Int?
  type        String
  points      Int
  description String
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  order       Order?    @relation(fields: [orderId], references: [id])
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("loyalty_transactions")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int?
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  data      String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model AdminLog {
  id          Int      @id @default(autoincrement())
  adminId     Int
  action      String
  entity      String
  entityId    Int?
  description String
  oldData     String?
  newData     String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  admin       User     @relation(fields: [adminId], references: [id])

  @@map("admin_logs")
}

model ProductHistory {
  id        Int      @id @default(autoincrement())
  productId Int
  changedBy Int
  field     String
  oldValue  String?
  newValue  String?
  reason    String?
  createdAt DateTime @default(now())
  changer   User     @relation(fields: [changedBy], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@map("product_history")
}

model OrderHistory {
  id        Int      @id @default(autoincrement())
  orderId   Int
  changedBy Int
  field     String
  oldValue  String?
  newValue  String?
  reason    String?
  createdAt DateTime @default(now())
  changer   User     @relation(fields: [changedBy], references: [id])
  order     Order    @relation(fields: [orderId], references: [id])

  @@map("order_history")
}
